# ARCHITECTURE.md - BIPPI

**Version:** 1.0  
**Created:** October 27, 2025  
**Last Updated:** October 27, 2025  
**Maintained by:** Development Team

---

## Project Overview

**Product:** Bippi  
**Type:** Mobile App (React Native) + Backend API  
**Status:** 🟡 Planning

**MVP Scope:**
Multi-retailer grocery scanner that enables users to:

- Scan products in real-time while shopping
- Track spending against monthly budget
- Build purchase history across multiple stores
- View frequently purchased products

**Target Launch:** December 8, 2025 (6 weeks)

---

## System Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────┐
│                   Mobile App                         │
│            (React Native + Expo)                    │
│                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │   Scanner    │  │  Dashboard   │  │  History  │ │
│  │    Screen    │  │    Screen    │  │   Screen  │ │
│  └──────────────┘  └──────────────┘  └───────────┘ │
└─────────────────────────┬───────────────────────────┘
                          │
                          │ HTTPS
                          │
┌─────────────────────────▼───────────────────────────┐
│                  API Gateway                         │
│              (FastAPI Backend)                       │
│                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │     Auth     │  │  Purchases   │  │ Products  │ │
│  │   Service    │  │   Service    │  │  Service  │ │
│  └──────────────┘  └──────────────┘  └───────────┘ │
└─────────────────────────┬───────────────────────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
┌─────────────▼─────────┐  ┌──────────▼──────────┐
│   Supabase Cloud      │  │   Redis Cache       │
│   - PostgreSQL 15     │  │   (Future Phase)    │
│   - Auth              │  │                     │
│   - Storage           │  └─────────────────────┘
└───────────────────────┘
```

### Architecture Principles

- **Separation of Concerns:** Mobile frontend, API backend, and database clearly separated
- **Stateless Design:** Backend API doesn't maintain session state (relies on JWT tokens)
- **API-First:** Backend exposes RESTful API consumed by mobile app
- **Security by Default:** Authentication required on all protected endpoints
- **Offline-First:** Mobile app can function offline for cart building, syncs when connection available
- **Scalability:** Designed to scale horizontally (stateless backend can add instances)

---

## Technology Stack

### Mobile Frontend

```yaml
Framework: React Native 0.72.6
Runtime: Expo SDK ~49.0.0
Language: TypeScript 5.2+
UI Components: React Native Paper (Material Design)
Navigation: React Navigation 6.x
State Management: Zustand 4.x (lightweight, simple)
HTTP Client: Axios 1.x
Form Handling: React Hook Form 7.x
Barcode Scanner: expo-barcode-scanner ~12.5.3
Camera: expo-camera ~13.4.4
Storage: @react-native-async-storage/async-storage 1.19+
Testing: Jest 29.x + React Native Testing Library
E2E Testing: Detox (future phase)
Linting: ESLint + Prettier
Package Manager: npm
```

### Backend

```yaml
Language: Python 3.11.6
Framework: FastAPI 0.104+
Database: PostgreSQL 15.5 (Supabase managed)
Database Client: asyncpg (async PostgreSQL driver)
ORM: SQLAlchemy 2.x (async mode)
Authentication: Supabase Auth (JWT tokens)
Validation: Pydantic 2.x (built into FastAPI)
CORS: fastapi.middleware.cors
Environment Config: python-dotenv
Logging: Python logging + structlog
Testing: pytest 7.x + pytest-asyncio
API Docs: FastAPI auto-generated (Swagger/OpenAPI)
ASGI Server: Uvicorn 0.24+
```

### Database & Infrastructure

```yaml
Primary Database: PostgreSQL 15.5 (Supabase)
Authentication: Supabase Auth
File Storage: Supabase Storage (future: receipt images)
Cache: Redis 7.2 (future phase for performance)
```

### DevOps & Infrastructure

```yaml
Version Control: Git + GitHub
CI/CD: GitHub Actions
Mobile Deployment:
  - iOS: TestFlight (beta) → App Store (production)
  - Android: Play Store Internal Testing (beta) → Play Store (production)
Backend Hosting: Railway or Render
Database Hosting: Supabase Cloud (managed PostgreSQL)
Error Tracking: Sentry (free tier)
Analytics: Expo Analytics (built-in)
Environment Management: .env files + GitHub Secrets
```

---

## Project Structure

### Mobile App Structure (React Native)

```
bippi-mobile/
│
├── src/
│   ├── features/                    # Feature-based modules
│   │   ├── auth/
│   │   │   ├── screens/
│   │   │   │   ├── LoginScreen.tsx
│   │   │   │   └── SignupScreen.tsx
│   │   │   ├── components/
│   │   │   │   └── AuthForm.tsx
│   │   │   ├── hooks/
│   │   │   │   └── useAuth.ts
│   │   │   ├── services/
│   │   │   │   └── authService.ts
│   │   │   └── types/
│   │   │       └── auth.types.ts
│   │   │
│   │   ├── scanner/
│   │   │   ├── screens/
│   │   │   │   └── ScannerScreen.tsx
│   │   │   ├── components/
│   │   │   │   ├── BarcodeScanner.tsx
│   │   │   │   ├── ManualEntryForm.tsx
│   │   │   │   ├── CartItemList.tsx
│   │   │   │   └── RunningTotal.tsx
│   │   │   ├── hooks/
│   │   │   │   └── useScanner.ts
│   │   │   ├── services/
│   │   │   │   └── scannerService.ts
│   │   │   └── types/
│   │   │       └── scanner.types.ts
│   │   │
│   │   ├── dashboard/
│   │   │   ├── screens/
│   │   │   │   └── DashboardScreen.tsx
│   │   │   ├── components/
│   │   │   │   ├── MonthlySpending.tsx
│   │   │   │   ├── BudgetProgress.tsx
│   │   │   │   └── RecentPurchases.tsx
│   │   │   └── hooks/
│   │   │       └── useDashboard.ts
│   │   │
│   │   ├── history/
│   │   │   ├── screens/
│   │   │   │   ├── HistoryScreen.tsx
│   │   │   │   └── PurchaseDetailScreen.tsx
│   │   │   ├── components/
│   │   │   │   ├── PurchaseList.tsx
│   │   │   │   └── PurchaseCard.tsx
│   │   │   └── hooks/
│   │   │       └── useHistory.ts
│   │   │
│   │   └── products/
│   │       ├── screens/
│   │       │   └── ProductsScreen.tsx
│   │       ├── components/
│   │       │   └── ProductList.tsx
│   │       └── hooks/
│   │           └── useProducts.ts
│   │
│   ├── shared/                      # Shared/reusable code
│   │   ├── components/
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Card.tsx
│   │   │   └── LoadingSpinner.tsx
│   │   ├── hooks/
│   │   │   ├── useApi.ts
│   │   │   └── useAsyncStorage.ts
│   │   ├── utils/
│   │   │   ├── formatters.ts
│   │   │   ├── validators.ts
│   │   │   └── constants.ts
│   │   └── types/
│   │       ├── api.types.ts
│   │       └── common.types.ts
│   │
│   ├── core/                        # Core services
│   │   ├── api/
│   │   │   ├── apiClient.ts
│   │   │   └── endpoints.ts
│   │   ├── storage/
│   │   │   └── storageService.ts
│   │   └── config/
│   │       └── appConfig.ts
│   │
│   ├── navigation/
│   │   ├── AppNavigator.tsx
│   │   ├── AuthNavigator.tsx
│   │   └── MainNavigator.tsx
│   │
│   └── store/                       # Global state (Zustand)
│       ├── authStore.ts
│       ├── cartStore.ts
│       └── userStore.ts
│
├── assets/
│   ├── images/
│   ├── fonts/
│   └── icons/
│
├── __tests__/
│   ├── features/
│   └── shared/
│
├── .env.example
├── .env.development
├── .env.production
├── app.json
├── babel.config.js
├── package.json
├── tsconfig.json
└── README.md
```

### Backend Structure (FastAPI)

```
bippi-backend/
│
├── src/
│   ├── api/
│   │   ├── v1/
│   │   │   ├── routes/
│   │   │   │   ├── auth.py
│   │   │   │   ├── purchases.py
│   │   │   │   ├── items.py
│   │   │   │   ├── products.py
│   │   │   │   └── users.py
│   │   │   └── __init__.py
│   │   └── dependencies.py
│   │
│   ├── core/
│   │   ├── config.py              # Settings & environment
│   │   ├── security.py            # JWT & auth utilities
│   │   └── database.py            # Database connection
│   │
│   ├── models/
│   │   ├── user.py
│   │   ├── purchase.py
│   │   ├── item.py
│   │   ├── product.py
│   │   └── price_history.py
│   │
│   ├── schemas/
│   │   ├── auth.py
│   │   ├── purchase.py
│   │   ├── item.py
│   │   ├── product.py
│   │   └── common.py
│   │
│   ├── services/
│   │   ├── auth_service.py
│   │   ├── purchase_service.py
│   │   ├── item_service.py
│   │   └── product_service.py
│   │
│   ├── middleware/
│   │   ├── error_handler.py
│   │   └── logging_middleware.py
│   │
│   └── utils/
│       ├── validators.py
│       ├── formatters.py
│       └── constants.py
│
├── tests/
│   ├── api/
│   ├── services/
│   └── conftest.py
│
├── alembic/                        # Database migrations
│   ├── versions/
│   └── env.py
│
├── .env.example
├── .env.development
├── .env.production
├── requirements.txt
├── requirements-dev.txt
├── pyproject.toml
├── pytest.ini
└── README.md
```

---

## Naming Conventions

### Mobile (TypeScript/React Native)

```typescript
// Files
LoginScreen.tsx           // Screens: PascalCase
AuthForm.tsx             // Components: PascalCase
useAuth.ts               // Hooks: camelCase with 'use' prefix
authService.ts           // Services: camelCase
auth.types.ts            // Types: camelCase

// Code
interface User {}        // Interfaces: PascalCase
type AuthResponse = {}   // Types: PascalCase
const API_URL = ''       // Constants: UPPER_SNAKE_CASE
const userName = ''      // Variables: camelCase
function handleLogin()   // Functions: camelCase
const MyComponent = ()   // Components: PascalCase
```

### Backend (Python/FastAPI)

```python
# Files
auth_service.py          # Modules: snake_case
purchase.py              # Models: snake_case

# Code
class User:              # Classes: PascalCase
def create_user():       # Functions: snake_case
USER_ROLE_ADMIN = ''     # Constants: UPPER_SNAKE_CASE
user_email = ''          # Variables: snake_case
```

### Git Commits (Conventional Commits)

```
feat: Add barcode scanner functionality
fix: Resolve camera permission issue on Android
docs: Update README with setup instructions
refactor: Simplify purchase service logic
test: Add unit tests for auth service
chore: Update dependencies
```

---

## API Design

### RESTful Endpoints

#### Base URL

```
Development: http://localhost:8000/api/v1
Production: https://api.bippi.app/api/v1
```

#### Authentication Endpoints

```
POST   /auth/signup         # Create new user
POST   /auth/login          # Login user
POST   /auth/logout         # Logout user
GET    /auth/me             # Get current user
POST   /auth/refresh        # Refresh access token
```

#### Purchase Endpoints

```
POST   /purchases           # Create new purchase
GET    /purchases           # Get user's purchases (with filters)
GET    /purchases/{id}      # Get purchase details
PUT    /purchases/{id}      # Update purchase
DELETE /purchases/{id}      # Delete purchase
GET    /purchases/stats     # Get monthly statistics
```

#### Item Endpoints

```
POST   /items               # Add item to purchase
GET    /purchases/{id}/items # Get items in purchase
DELETE /items/{id}          # Delete item
```

#### Product Endpoints

```
GET    /products/barcode/{code}      # Lookup product by barcode
POST   /products                      # Create new product
GET    /products/{id}                 # Get product details
GET    /products/{id}/price-history  # Get price history
GET    /products/frequent             # Get user's frequent products
```

#### User Endpoints

```
GET    /users/me            # Get current user profile
PUT    /users/me            # Update user profile
PUT    /users/me/budget     # Update monthly budget
```

### API Response Format

#### Success Response

```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "attribute1": "value",
    "attribute2": "value"
  },
  "meta": {
    "timestamp": "2025-10-27T10:00:00Z",
    "version": "v1"
  }
}
```

#### List Response

```json
{
  "success": true,
  "data": [
    { "id": "uuid1", "...": "..." },
    { "id": "uuid2", "...": "..." }
  ],
  "meta": {
    "total": 25,
    "page": 1,
    "per_page": 10,
    "timestamp": "2025-10-27T10:00:00Z"
  }
}
```

#### Error Response

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "details": {
      "field": "email",
      "value": "invalid-email"
    }
  },
  "meta": {
    "timestamp": "2025-10-27T10:00:00Z"
  }
}
```

### Error Codes

```python
# Authentication Errors
UNAUTHORIZED = "UNAUTHORIZED"                    # 401
FORBIDDEN = "FORBIDDEN"                          # 403
TOKEN_EXPIRED = "TOKEN_EXPIRED"                  # 401

# Validation Errors
VALIDATION_ERROR = "VALIDATION_ERROR"            # 400
MISSING_FIELD = "MISSING_FIELD"                  # 400

# Resource Errors
NOT_FOUND = "NOT_FOUND"                          # 404
ALREADY_EXISTS = "ALREADY_EXISTS"                # 409

# Server Errors
INTERNAL_ERROR = "INTERNAL_ERROR"                # 500
DATABASE_ERROR = "DATABASE_ERROR"                # 500
```

### Request/Response Examples

#### Create Purchase

```http
POST /api/v1/purchases
Authorization: Bearer {token}
Content-Type: application/json

{
  "store_name": "Loblaws",
  "items": [
    {
      "barcode": "012345678905",
      "product_name": "Milk 2%",
      "price": 4.99
    },
    {
      "barcode": "987654321098",
      "product_name": "Bread",
      "price": 2.49
    }
  ],
  "latitude": 43.6532,
  "longitude": -79.3832
}
```

#### Get Monthly Statistics

```http
GET /api/v1/purchases/stats?month=10&year=2025
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "total_spent": 487.32,
    "budget": 600.00,
    "remaining": 112.68,
    "purchases_count": 12,
    "most_frequent_store": "No Frills",
    "top_categories": [
      {"category": "Dairy", "amount": 87.50},
      {"category": "Produce", "amount": 65.30}
    ]
  }
}
```

---

## Database Schema

### PostgreSQL Schema

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    monthly_budget DECIMAL(10,2) DEFAULT 600.00,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Purchases table
CREATE TABLE purchases (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    store_name VARCHAR(100) NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    purchase_date TIMESTAMP DEFAULT NOW(),
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Items table
CREATE TABLE items (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    purchase_id UUID NOT NULL REFERENCES purchases(id) ON DELETE CASCADE,
    barcode VARCHAR(50),
    product_name VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Products table (unique products catalog)
CREATE TABLE products (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    barcode VARCHAR(50) UNIQUE NOT NULL,
    common_name VARCHAR(255),
    category VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Price history table (crowdsourced pricing)
CREATE TABLE price_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    store_name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    reported_by UUID REFERENCES users(id),
    reported_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_purchases_user_id ON purchases(user_id);
CREATE INDEX idx_purchases_date ON purchases(purchase_date);
CREATE INDEX idx_items_purchase_id ON items(purchase_id);
CREATE INDEX idx_items_barcode ON items(barcode);
CREATE INDEX idx_products_barcode ON products(barcode);
CREATE INDEX idx_price_history_product_id ON price_history(product_id);
CREATE INDEX idx_price_history_store ON price_history(store_name);
```

### Row-Level Security (Supabase RLS)

```sql
-- Enable RLS on all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE purchases ENABLE ROW LEVEL SECURITY;
ALTER TABLE items ENABLE ROW LEVEL SECURITY;

-- Users can only see their own data
CREATE POLICY "Users can view own profile"
    ON users FOR SELECT
    USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
    ON users FOR UPDATE
    USING (auth.uid() = id);

-- Purchases policies
CREATE POLICY "Users can view own purchases"
    ON purchases FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can create own purchases"
    ON purchases FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete own purchases"
    ON purchases FOR DELETE
    USING (auth.uid() = user_id);

-- Items policies
CREATE POLICY "Users can view items from own purchases"
    ON items FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM purchases
            WHERE purchases.id = items.purchase_id
            AND purchases.user_id = auth.uid()
        )
    );
```

---

## Security Architecture

### Authentication Flow

```
1. User signs up/logs in
2. Supabase Auth returns JWT access token + refresh token
3. Mobile app stores tokens securely (AsyncStorage)
4. Every API request includes: Authorization: Bearer {access_token}
5. Backend validates JWT with Supabase
6. If token expired, mobile app refreshes automatically
```

### Security Measures

#### API Security

```python
# CORS Configuration
ALLOWED_ORIGINS = [
    "exp://localhost:19000",  # Expo development
    "https://bippi.app",      # Production web (future)
]

# Rate Limiting (future phase with Redis)
RATE_LIMIT_PER_MINUTE = 60

# Request Size Limits
MAX_UPLOAD_SIZE = 10 * 1024 * 1024  # 10MB
```

#### Data Validation

```python
# All inputs validated with Pydantic
class PurchaseCreate(BaseModel):
    store_name: str = Field(min_length=1, max_length=100)
    items: List[ItemCreate] = Field(min_items=1)
    latitude: Optional[float] = Field(ge=-90, le=90)
    longitude: Optional[float] = Field(ge=-180, le=180)
```

#### Sensitive Data Handling

```yaml
Passwords: Never stored (Supabase handles hashing)
Tokens: Stored in AsyncStorage (encrypted on iOS/Android by default)
API Keys: Environment variables only, never committed
User Location: Optional, stored only with explicit permission
Payment Data: Not stored (future: use Stripe/similar)
```

### Environment Variables

#### Mobile (.env files)

```bash
# Development
EXPO_PUBLIC_API_URL=http://localhost:8000/api/v1
EXPO_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
EXPO_PUBLIC_SENTRY_DSN=https://xxx@sentry.io/xxx

# Production
EXPO_PUBLIC_API_URL=https://api.bippi.app/api/v1
EXPO_PUBLIC_SUPABASE_URL=https://prod.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJyyy...
EXPO_PUBLIC_SENTRY_DSN=https://yyy@sentry.io/yyy
```

#### Backend (.env files)

```bash
# Development
DATABASE_URL=postgresql://user:pass@localhost:5432/bippi_dev
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJxxx...
JWT_SECRET=dev-secret-key
ENVIRONMENT=development

# Production
DATABASE_URL=postgresql://user:pass@supabase:5432/bippi_prod
SUPABASE_URL=https://prod.supabase.co
SUPABASE_SERVICE_KEY=eyJyyy...
JWT_SECRET=prod-secret-key-from-github-secrets
ENVIRONMENT=production
SENTRY_DSN=https://zzz@sentry.io/zzz
```

---

## Performance Optimization

### Backend Performance

```python
# Database Connection Pooling
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession

engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=0,
    pool_pre_ping=True,
    pool_recycle=3600,
)

# Query Optimization - Select only needed fields
async def get_purchases(user_id: UUID, limit: int = 10):
    query = select(
        Purchase.id,
        Purchase.store_name,
        Purchase.total_amount,
        Purchase.purchase_date
    ).where(
        Purchase.user_id == user_id
    ).limit(limit).order_by(
        Purchase.purchase_date.desc()
    )
    return await session.execute(query)

# Eager Loading - Avoid N+1 queries
from sqlalchemy.orm import selectinload

query = select(Purchase).options(
    selectinload(Purchase.items)
).where(Purchase.id == purchase_id)
```

### Mobile Performance

```typescript
// Code Splitting - Lazy load screens
const ScannerScreen = lazy(
  () => import("./features/scanner/screens/ScannerScreen")
);
const HistoryScreen = lazy(
  () => import("./features/history/screens/HistoryScreen")
);

// Memoization - Expensive calculations
const monthlyTotal = useMemo(() => {
  return purchases.reduce((sum, p) => sum + p.total_amount, 0);
}, [purchases]);

// Optimized Lists - Use FlashList instead of FlatList
import { FlashList } from "@shopify/flash-list";

<FlashList
  data={purchases}
  renderItem={({ item }) => <PurchaseCard purchase={item} />}
  estimatedItemSize={80}
/>;

// Image Optimization
import { Image } from "expo-image";

<Image
  source={{ uri: imageUrl }}
  contentFit="cover"
  cachePolicy="memory-disk"
/>;
```

### Performance Targets

```yaml
API Response Times:
  - GET endpoints: < 100ms (p95)
  - POST endpoints: < 200ms (p95)
  - Complex queries: < 500ms (p95)

Mobile App:
  - App Launch: < 2 seconds
  - Screen Transitions: < 200ms
  - Scanner Recognition: < 1 second
  - API Call Response: < 300ms (including network)

Database:
  - Query Execution: < 50ms (p95)
  - Connection Time: < 10ms
```

---

## Testing Strategy

### Test Coverage Targets

```yaml
Backend:
  - Statements: > 80%
  - Branches: > 75%
  - Functions: > 80%
  - Lines: > 80%

Mobile:
  - Critical Paths: > 90%
  - Components: > 70%
  - Services: > 85%
  - Utilities: > 90%
```

### Backend Testing

#### Unit Tests (pytest)

```python
# tests/services/test_purchase_service.py
import pytest
from src.services.purchase_service import PurchaseService

@pytest.mark.asyncio
async def test_create_purchase(db_session, test_user):
    service = PurchaseService(db_session)

    purchase_data = {
        "user_id": test_user.id,
        "store_name": "Loblaws",
        "total_amount": 42.50,
        "items": [
            {"barcode": "123", "product_name": "Milk", "price": 4.99}
        ]
    }

    purchase = await service.create(purchase_data)

    assert purchase.id is not None
    assert purchase.store_name == "Loblaws"
    assert purchase.total_amount == 42.50
    assert len(purchase.items) == 1
```

#### Integration Tests (pytest + TestClient)

```python
# tests/api/test_purchases.py
from httpx import AsyncClient

@pytest.mark.asyncio
async def test_create_purchase_endpoint(client: AsyncClient, auth_headers):
    response = await client.post(
        "/api/v1/purchases",
        json={
            "store_name": "No Frills",
            "items": [
                {"barcode": "456", "product_name": "Bread", "price": 2.49}
            ]
        },
        headers=auth_headers
    )

    assert response.status_code == 201
    data = response.json()
    assert data["success"] is True
    assert data["data"]["store_name"] == "No Frills"
```

### Mobile Testing

#### Unit Tests (Jest)

```typescript
// __tests__/services/authService.test.ts
import { authService } from "@/features/auth/services/authService";

describe("AuthService", () => {
  describe("login", () => {
    it("should return user and token on successful login", async () => {
      const credentials = {
        email: "test@example.com",
        password: "password123",
      };

      const result = await authService.login(credentials);

      expect(result.user).toBeDefined();
      expect(result.token).toBeDefined();
      expect(result.user.email).toBe(credentials.email);
    });
  });
});
```

#### Component Tests (React Native Testing Library)

```typescript
// __tests__/features/scanner/RunningTotal.test.tsx
import { render, screen } from "@testing-library/react-native";
import { RunningTotal } from "@/features/scanner/components/RunningTotal";

describe("RunningTotal", () => {
  it("should display formatted total amount", () => {
    render(<RunningTotal total={42.5} />);

    expect(screen.getByText("$42.50")).toBeTruthy();
  });

  it("should display zero when no items", () => {
    render(<RunningTotal total={0} />);

    expect(screen.getByText("$0.00")).toBeTruthy();
  });
});
```

---

## Deployment Architecture

### Environments

#### Development

```yaml
Purpose: Local development and testing
Mobile: Expo Go (development build)
Backend: http://localhost:8000
Database: Supabase development project
Auth: Supabase Auth (dev project)
Debugging: Full debug logs enabled
Hot Reload: Enabled
Error Tracking: Sentry (disabled or separate project)
```

#### Production

```yaml
Purpose: Live application for beta/public users
Mobile:
  - iOS: TestFlight → App Store
  - Android: Play Store Internal → Production
Backend: https://api.bippi.app (Railway/Render)
Database: Supabase production project
Auth: Supabase Auth (production project)
Monitoring: Sentry enabled
Analytics: Expo Analytics enabled
CDN: Cloudflare (future)
Auto-scaling: Enabled on hosting platform
Backups: Automated daily (Supabase)
```

### CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/mobile-ci.yml

name: Mobile CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "18"
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test

  build-ios:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - run: npm ci
      - run: npx expo build:ios --release-channel production
      - run: npx expo upload:ios

  build-android:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - run: npm ci
      - run: npx expo build:android --release-channel production
      - run: npx expo upload:android
```

```yaml
# .github/workflows/backend-ci.yml

name: Backend CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: pip install -r requirements-dev.txt
      - run: black --check .
      - run: ruff check .
      - run: mypy src/
      - run: pytest tests/ --cov=src --cov-report=xml

  deploy-production:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Railway
        run: |
          curl -X POST ${{ secrets.RAILWAY_WEBHOOK_URL }}
```

### Deployment Checklist

```markdown
Pre-Deployment:

- [ ] All tests passing (mobile + backend)
- [ ] Code reviewed and approved
- [ ] Environment variables updated in GitHub Secrets
- [ ] Database migrations tested in development
- [ ] Changelog/release notes updated
- [ ] Sentry releases configured

Post-Deployment:

- [ ] Mobile builds uploaded (TestFlight/Play Store)
- [ ] Backend health check passing
- [ ] Database migrations applied successfully
- [ ] Sentry error tracking confirmed working
- [ ] Smoke tests passed (critical user flows)
- [ ] Performance metrics within targets
- [ ] Team notified in Slack/Discord
```

---

## Monitoring & Logging

### Error Tracking (Sentry)

#### Mobile Setup

```typescript
// src/core/config/sentry.ts
import * as Sentry from "@sentry/react-native";

Sentry.init({
  dsn: process.env.EXPO_PUBLIC_SENTRY_DSN,
  environment: process.env.EXPO_PUBLIC_ENVIRONMENT,
  enableAutoSessionTracking: true,
  sessionTrackingIntervalMillis: 10000,
  tracesSampleRate: 1.0,
});

// Usage in error boundaries
try {
  await scannerService.processBarcode(barcode);
} catch (error) {
  Sentry.captureException(error, {
    tags: { feature: "scanner" },
    contexts: {
      barcode: { value: barcode },
    },
  });
}
```

#### Backend Setup

```python
# src/core/config.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn=os.getenv("SENTRY_DSN"),
    environment=os.getenv("ENVIRONMENT"),
    integrations=[FastApiIntegration()],
    traces_sample_rate=1.0,
)

# Usage
try:
    purchase = await purchase_service.create(data)
except Exception as e:
    sentry_sdk.capture_exception(
        e,
        tags={"service": "purchase"},
        contexts={"user_id": current_user.id}
    )
    raise
```

### Logging Strategy

#### Backend Logging

```python
# src/core/logging_config.py
import logging
import structlog

logging.basicConfig(
    format="%(message)s",
    level=logging.INFO,
)

structlog.configure(
    processors=[
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.add_log_level,
        structlog.processors.JSONRenderer()
    ],
    logger_factory=structlog.stdlib.LoggerFactory(),
)

logger = structlog.get_logger()

# Usage
logger.info("purchase_created",
    user_id=user.id,
    purchase_id=purchase.id,
    store=purchase.store_name,
    amount=purchase.total_amount
)
```

### Monitoring Metrics

```yaml
Infrastructure:
  - CPU usage (Railway/Render dashboard)
  - Memory usage
  - Request rate
  - Error rate

Application:
  - API response times (p50, p95, p99)
  - Active users (Expo Analytics)
  - Feature usage (custom events)
  - Crash-free rate (Sentry)

Business:
  - User signups per day
  - Purchases created per day
  - Scanner success rate
  - Average items per purchase
```

---

## Maintenance & Updates

### Update Schedule

```yaml
Dependencies:
  - Security patches: Immediate (within 24h)
  - Minor updates: Monthly
  - Major updates: Quarterly (after testing in dev)

Framework Updates:
  - React Native: Every 2 minor versions
  - Expo SDK: Every major version
  - FastAPI: As needed (stable framework)
  - Python: Annually (3.11 → 3.12+)

Database:
  - PostgreSQL: Major versions annually
  - Schema changes: Via Alembic migrations
```

### Backup Strategy

```yaml
Database (Supabase):
  - Automated daily backups (retained 30 days)
  - Point-in-time recovery available
  - Manual backup before major migrations

Code:
  - Version controlled in GitHub
  - Tags for each release
  - Protected main branch

Configuration:
  - Environment variables in GitHub Secrets
  - Infrastructure as Code (future: Terraform)
```

### Disaster Recovery

```yaml
RTO (Recovery Time Objective): 4 hours
RPO (Recovery Point Objective): 1 hour (database backup frequency)

Recovery Process: 1. Identify issue (Sentry alerts + monitoring)
  2. Assess impact (affected users, data loss)
  3. Restore from backup if needed (Supabase restore)
  4. Redeploy last known good version
  5. Verify functionality (smoke tests)
  6. Communicate with users (in-app notification)
  7. Post-mortem within 48 hours
```

---

## Document Maintenance

**Review Frequency:**

- Post-MVP launch (after Week 6)
- Quarterly thereafter
- Immediately after major architectural changes

**Update Triggers:**

- New technology adoption (e.g., adding Redis cache)
- Major refactoring (e.g., restructuring mobile app)
- Security updates (e.g., new authentication method)
- Performance optimization changes
- New external integrations

**Version History:**

| Version | Date             | Changes                      | Author           |
| ------- | ---------------- | ---------------------------- | ---------------- |
| 1.0     | October 27, 2025 | Initial architecture for MVP | Development Team |

---

**Last Updated:** October 27, 2025  
**Next Review:** December 22, 2025 (post-beta launch)  
**Maintained by:** Development Team
